<!-- app/templates/recommendations.html -->
{% extends "base.html" %}

{% block content %}
<div class="recommendations-page">
    <div class="container">
        <div class="page-header">
            <h1><i class="fas fa-bookmark"></i> Your Saved Recommendations</h1>
            <p>Review and manage your location analysis results</p>
        </div>

        <div class="recommendations-toolbar">
            <div class="search-filter">
                <input type="text" id="filter-input" placeholder="Filter by location..." 
                       onkeyup="filterRecommendations()">
            </div>
            <div class="sort-options">
                <select id="sort-select" onchange="sortRecommendations()">
                    <option value="newest">Newest First</option>
                    <option value="oldest">Oldest First</option>
                    <option value="confidence">Highest Confidence</option>
                    <option value="location">By Location</option>
                </select>
            </div>
            <button class="btn btn-primary" onclick="window.location.href='/analysis'">
                <i class="fas fa-plus"></i> New Analysis
            </button>
        </div>

        <div id="saved-recommendations" class="recommendations-grid">
            <div class="loading-placeholder">
                <div class="loading-spinner"></div>
                <p>Loading your recommendations...</p>
            </div>
        </div>

        <div id="empty-state" class="empty-state hidden">
            <div class="empty-content">
                <i class="fas fa-map-marked-alt"></i>
                <h3>No Recommendations Yet</h3>
                <p>Start analyzing locations to build your recommendation library</p>
                <a href="/analysis" class="btn btn-primary">
                    <i class="fas fa-search"></i> Start First Analysis
                </a>
            </div>
        </div>
    </div>
</div>

<div id="recommendation-modal" class="modal hidden">
    <div class="modal-content large-modal">
        <div class="modal-header">
            <h3>Recommendation Details</h3>
            <button class="close-btn" onclick="closeRecommendationModal()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div id="modal-recommendation-content">
            <!-- Content will be loaded here -->
        </div>
    </div>
</div>

<style>
.recommendations-page {
    padding: 2rem;
    min-height: calc(100vh - 200px);
}

.page-header {
    text-align: center;
    color: white;
    margin-bottom: 3rem;
}

.page-header h1 {
    font-size: 2.5rem;
    margin-bottom: 0.5rem;
}

.recommendations-toolbar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: rgba(255, 255, 255, 0.95);
    padding: 1rem 2rem;
    border-radius: 12px;
    margin-bottom: 2rem;
    box-shadow: var(--shadow);
    gap: 1rem;
}

.search-filter input {
    padding: 0.5rem 1rem;
    border: 1px solid var(--border-color);
    border-radius: 8px;
    width: 250px;
}

.sort-options select {
    padding: 0.5rem 1rem;
    border: 1px solid var(--border-color);
    border-radius: 8px;
    background: white;
}

.recommendations-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
    gap: 2rem;
}

.recommendation-summary {
    background: rgba(255, 255, 255, 0.95);
    padding: 2rem;
    border-radius: 16px;
    box-shadow: var(--shadow);
    border-left: 4px solid var(--primary-color);
    transition: transform 0.3s ease;
}

.recommendation-summary:hover {
    transform: translateY(-5px);
}

.recommendation-summary h3 {
    color: var(--primary-color);
    margin-bottom: 0.5rem;
    font-size: 1.3rem;
}

.recommendation-meta {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
    font-size: 0.9rem;
    color: var(--text-color);
    opacity: 0.8;
}

.confidence-mini {
    padding: 0.25rem 0.75rem;
    border-radius: 12px;
    font-weight: 600;
    color: white;
    font-size: 0.8rem;
}

.recommendation-preview {
    margin-bottom: 1.5rem;
}

.preview-metrics {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 0.5rem;
    margin: 1rem 0;
}

.preview-metric {
    text-align: center;
    padding: 0.5rem;
    background: var(--light-color);
    border-radius: 6px;
    border: 1px solid var(--border-color);
}

.preview-metric-value {
    font-weight: 700;
    color: var(--primary-color);
    font-size: 1.1rem;
}

.preview-metric-label {
    font-size: 0.8rem;
    color: var(--text-color);
    opacity: 0.8;
}

.recommendation-actions {
    display: flex;
    gap: 0.5rem;
}

.btn-sm {
    padding: 0.5rem 1rem;
    font-size: 0.9rem;
}

.empty-state {
    text-align: center;
    padding: 4rem 2rem;
    color: white;
}

.empty-content i {
    font-size: 4rem;
    margin-bottom: 1rem;
    opacity: 0.7;
}

.empty-content h3 {
    font-size: 1.8rem;
    margin-bottom: 1rem;
}

.loading-placeholder {
    grid-column: 1 / -1;
    text-align: center;
    padding: 3rem;
    color: white;
}

.large-modal .modal-content {
    max-width: 800px;
    width: 90vw;
    max-height: 90vh;
    overflow-y: auto;
}

.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 2rem;
    padding-bottom: 1rem;
    border-bottom: 2px solid var(--border-color);
}

.close-btn {
    background: none;
    border: none;
    font-size: 1.5rem;
    cursor: pointer;
    color: var(--text-color);
    padding: 0.5rem;
    border-radius: 50%;
    transition: background 0.3s ease;
}

.close-btn:hover {
    background: var(--light-color);
}

@media (max-width: 768px) {
    .recommendations-toolbar {
        flex-direction: column;
        gap: 1rem;
    }
    
    .search-filter input {
        width: 100%;
    }
    
    .recommendations-grid {
        grid-template-columns: 1fr;
    }
    
    .preview-metrics {
        grid-template-columns: 1fr;
    }
    
    .recommendation-actions {
        flex-direction: column;
    }
}
</style>

<script>
let allRecommendations = [];

document.addEventListener('DOMContentLoaded', function() {
    loadSavedRecommendations();
});

function loadSavedRecommendations() {
    const savedAnalyses = JSON.parse(localStorage.getItem('savedAnalyses') || '[]');
    const container = document.getElementById('saved-recommendations');
    const emptyState = document.getElementById('empty-state');
    
    if (savedAnalyses.length === 0) {
        container.classList.add('hidden');
        emptyState.classList.remove('hidden');
        return;
    }
    
    allRecommendations = savedAnalyses;
    displayRecommendations(savedAnalyses);
}

function displayRecommendations(recommendations) {
    const container = document.getElementById('saved-recommendations');
    
    if (recommendations.length === 0) {
        container.innerHTML = `
            <div class="no-results">
                <p>No recommendations match your filter criteria.</p>
            </div>
        `;
        return;
    }
    
    const html = recommendations.map(analysis => `
        <div class="recommendation-summary" data-location="${analysis.location.toLowerCase()}">
            <h3>${analysis.location}</h3>
            <div class="recommendation-meta">
                <span><i class="fas fa-calendar"></i> ${new Date(analysis.timestamp).toLocaleDateString()}</span>
                <span class="confidence-mini confidence-medium">Saved</span>
            </div>
            
            <div class="recommendation-preview">
                <p><strong>Analysis ID:</strong> ${analysis.id}</p>
                <p><strong>Type:</strong> ${analysis.type || 'Standard'} Analysis</p>
            </div>
            
            <div class="recommendation-actions">
                <button onclick="loadAnalysisDetails('${analysis.id}')" class="btn btn-primary btn-sm">
                    <i class="fas fa-eye"></i> View Details
                </button>
                <button onclick="deleteRecommendation('${analysis.id}')" class="btn btn-secondary btn-sm">
                    <i class="fas fa-trash"></i> Delete
                </button>
                <button onclick="shareRecommendation('${analysis.id}')" class="btn btn-secondary btn-sm">
                    <i class="fas fa-share"></i> Share
                </button>
            </div>
        </div>
    `).join('');
    
    container.innerHTML = html;
    container.classList.remove('hidden');
    document.getElementById('empty-state').classList.add('hidden');
}

function filterRecommendations() {
    const filterValue = document.getElementById('filter-input').value.toLowerCase();
    const filteredRecommendations = allRecommendations.filter(rec => 
        rec.location.toLowerCase().includes(filterValue)
    );
    displayRecommendations(filteredRecommendations);
}

function sortRecommendations() {
    const sortValue = document.getElementById('sort-select').value;
    let sortedRecommendations = [...allRecommendations];
    
    switch(sortValue) {
        case 'newest':
            sortedRecommendations.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            break;
        case 'oldest':
            sortedRecommendations.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
            break;
        case 'location':
            sortedRecommendations.sort((a, b) => a.location.localeCompare(b.location));
            break;
        case 'confidence':
            // For now, just sort by newest since we don't store confidence in localStorage
            sortedRecommendations.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            break;
    }
    
    displayRecommendations(sortedRecommendations);
}

async function loadAnalysisDetails(analysisId) {
    try {
        const response = await fetch(`/api/analysis/${analysisId}`);
        const analysis = await response.json();
        
        if (response.ok) {
            displayAnalysisInModal(analysis);
        } else {
            alert('Failed to load analysis details');
        }
    } catch (error) {
        alert('Error loading analysis details');
    }
}

function displayAnalysisInModal(analysis) {
    const modal = document.getElementById('recommendation-modal');
    const content = document.getElementById('modal-recommendation-content');
    
    const recommendation = analysis.data.recommendation;
    
    content.innerHTML = `
        <div class="modal-recommendation">
            <div class="recommendation-overview">
                <h4>Location: ${analysis.data.location}</h4>
                <p><strong>Business Type:</strong> ${analysis.data.business_type}</p>
                <p><strong>Confidence Score:</strong> ${Math.round(recommendation.confidence_score)}%</p>
            </div>
            
            <div class="modal-insights">
                <h4>Key Insights</h4>
                <p>${recommendation.reasoning}</p>
                
                <div class="modal-metrics">
                    <div class="modal-metric">
                        <strong>Revenue Potential:</strong> ${recommendation.estimated_revenue_potential}
                    </div>
                    <div class="modal-metric">
                        <strong>Recommended Duration:</strong> ${recommendation.recommended_duration}
                    </div>
                </div>
                
                ${recommendation.setup_requirements.length > 0 ? `
                <div class="modal-requirements">
                    <strong>Setup Requirements:</strong>
                    <ul>
                        ${recommendation.setup_requirements.map(req => `<li>${req}</li>`).join('')}
                    </ul>
                </div>
                ` : ''}
            </div>
        </div>
    `;
    
    modal.classList.remove('hidden');
}

function closeRecommendationModal() {
    document.getElementById('recommendation-modal').classList.add('hidden');
}

function deleteRecommendation(analysisId) {
    if (confirm('Are you sure you want to delete this recommendation?')) {
        let savedAnalyses = JSON.parse(localStorage.getItem('savedAnalyses') || '[]');
        savedAnalyses = savedAnalyses.filter(analysis => analysis.id !== analysisId);
        localStorage.setItem('savedAnalyses', JSON.stringify(savedAnalyses));
        
        // Reload the page
        loadSavedRecommendations();
    }
}

function shareRecommendation(analysisId) {
    const shareUrl = `${window.location.origin}/api/analysis/${analysisId}`;
    
    if (navigator.share) {
        navigator.share({
            title: 'Choks Location Analysis',
            text: 'Check out this location analysis from Choks',
            url: shareUrl
        });
    } else {
        // Fallback - copy to clipboard
        navigator.clipboard.writeText(shareUrl).then(() => {
            alert('Analysis link copied to clipboard!');
        }).catch(() => {
            alert(`Share this link: ${shareUrl}`);
        });
    }
}

// Close modal when clicking outside
document.addEventListener('click', function(event) {
    const modal = document.getElementById('recommendation-modal');
    if (event.target === modal) {
        closeRecommendationModal();
    }
});
</script>

<style>
.recommendations-page {
    padding: 2rem;
    min-height: calc(100vh - 200px);
}

.page-header {
    text-align: center;
    color: white;
    margin-bottom: 3rem;
}

.page-header h1 {
    font-size: 2.5rem;
    margin-bottom: 0.5rem;
}

.recommendations-toolbar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: rgba(255, 255, 255, 0.95);
    padding: 1rem 2rem;
    border-radius: 12px;
    margin-bottom: 2rem;
    box-shadow: var(--shadow);
    gap: 1rem;
}

.search-filter input {
    padding: 0.5rem 1rem;
    border: 1px solid var(--border-color);
    border-radius: 8px;
    width: 250px;
}

.sort-options select {
    padding: 0.5rem 1rem;
    border: 1px solid var(--border-color);
    border-radius: 8px;
    background: white;
}

.recommendations-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
    gap: 2rem;
}

.recommendation-summary {
    background: rgba(255, 255, 255, 0.95);
    padding: 2rem;
    border-radius: 16px;
    box-shadow: var(--shadow);
    border-left: 4px solid var(--primary-color);
    transition: transform 0.3s ease;
}

.recommendation-summary:hover {
    transform: translateY(-5px);
}

.recommendation-summary h3 {
    color: var(--primary-color);
    margin-bottom: 0.5rem;
    font-size: 1.3rem;
}

.recommendation-meta {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
    font-size: 0.9rem;
    color: var(--text-color);
    opacity: 0.8;
}

.confidence-mini {
    padding: 0.25rem 0.75rem;
    border-radius: 12px;
    font-weight: 600;
    color: white;
    font-size: 0.8rem;
    background: var(--success-color);
}

.recommendation-preview {
    margin-bottom: 1.5rem;
}

.recommendation-actions {
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
}

.empty-state {
    text-align: center;
    padding: 4rem 2rem;
    color: white;
}

.empty-content i {
    font-size: 4rem;
    margin-bottom: 1rem;
    opacity: 0.7;
}

.empty-content h3 {
    font-size: 1.8rem;
    margin-bottom: 1rem;
}

.loading-placeholder {
    grid-column: 1 / -1;
    text-align: center;
    padding: 3rem;
    color: white;
}

.large-modal .modal-content {
    max-width: 700px;
    width: 90vw;
    max-height: 80vh;
    overflow-y: auto;
}

.modal-recommendation {
    padding: 1rem;
}

.recommendation-overview {
    background: var(--light-color);
    padding: 1.5rem;
    border-radius: 8px;
    margin-bottom: 2rem;
}

.modal-insights h4 {
    color: var(--primary-color);
    margin-bottom: 1rem;
}

.modal-metrics {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1rem;
    margin: 1rem 0;
}

.modal-metric {
    background: var(--light-color);
    padding: 1rem;
    border-radius: 8px;
    border: 1px solid var(--border-color);
}

.modal-requirements {
    margin-top: 1.5rem;
}

.modal-requirements ul {
    margin-top: 0.5rem;
    padding-left: 1.5rem;
}

.no-results {
    grid-column: 1 / -1;
    text-align: center;
    padding: 3rem;
    background: rgba(255, 255, 255, 0.95);
    border-radius: 12px;
    color: var(--text-color);
}

@media (max-width: 768px) {
    .recommendations-toolbar {
        flex-direction: column;
        gap: 1rem;
    }
    
    .search-filter input {
        width: 100%;
    }
    
    .recommendations-grid {
        grid-template-columns: 1fr;
    }
    
    .recommendation-actions {
        justify-content: center;
    }
    
    .modal-metrics {
        grid-template-columns: 1fr;
    }
}
</style>
{% endblock %}